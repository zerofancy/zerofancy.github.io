<!doctype html>
<html lang="zh-CN">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <title>Hello, world!</title>
</head>

<body>
    <nav class="container navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/favicon.ico" alt="归零幻想" width="20px" height="20px">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                <!--
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Dropdown
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Action</a></li>
                            <li><a class="dropdown-item" href="#">Another action</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Something else here</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                    </li>
                -->
                </ul>
                <!--
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
                -->
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <div class="row">
            <div class="card col-md-4 d-none d-md-block me-md-3 text-center" style="width: 18rem;">
                <img src="/favicon.ico" alt="avatar" class="mt-3">
                <div class="card-body">
                    <p class="card-text">
                        归零幻想
                    </p>
                </div>
            </div>
    
            <div class="card col">
                <div class="card-body"><p>title: 装饰模式实现分享功能
author: 归零幻想
publishDate: 2021-07-19
editDate: 2021-07-19
tags: [设计模式, Kotlin, 分享]</p>
<!--config-->
<p>在看业务代码时发现了一段代码，应用了装饰模式处理了分享功能的实现，非常巧妙，共赏。</p>
<p><img src="https://i.loli.net/2021/07/19/yiSRrDhZx4AT9GI.png" alt="装饰模式.svg.png.lin.png" /></p>
<!--summary-->
<h2 id="代码">代码</h2>
<p>业务代码不可能直接贴出来，我按照大致的设计写了如下demo。</p>
<pre><code class="language-kt">import java.lang.IllegalArgumentException

fun main() {
    listOf(
        ShareData(listOf(&quot;图1&quot;, &quot;图2&quot;, &quot;图3&quot;), true),
        ShareData(listOf(&quot;图1&quot;, &quot;图2&quot;, &quot;图3&quot;), false),
        ShareData(listOf(&quot;视频1&quot;, &quot;视频2&quot;, &quot;视频3&quot;), true),
        ShareData(listOf(&quot;视频1&quot;, &quot;视频2&quot;, &quot;视频3&quot;), false),
        ShareData(listOf(&quot;图1&quot;, &quot;视频2&quot;, &quot;图3&quot;), true),
        ShareData(listOf(&quot;图1&quot;, &quot;视频2&quot;, &quot;图3&quot;), false)
    ).forEach {
        println(&quot;测试$it&quot;)
        if (it.handler.requestPermission()) {
            it.handler.doShare(it)
        } else {
            println(&quot;申请权限失败&quot;)
        }
        println()
    }
}

class ShareData(val urls: List&lt;String&gt;, val isFromSDK: Boolean) {
    companion object {
        const val IMAGE = 0x1
        const val VIDEO = 0x2
        const val MIX = IMAGE.or(VIDEO)
    }

    val handler by lazy {
        var res: ShareHandler = ShareHandlerImpl()
        res = if (isFromSDK) ShareFromSdkHandler(res) else ShareFromSystemHandler(res)
        var result = 0
        urls.forEach { result = result.or(getUrlType(it)) }
        res = when (result) {
            IMAGE -&gt; ShareImageHandler(res)
            VIDEO -&gt; ShareVideoHandler(res)
            MIX -&gt; ShareMixHandler(res)
            else -&gt; throw IllegalArgumentException(&quot;不能处理的参数类型&quot;)
        }
        res
    }

    private fun getUrlType(url: String): Int = if (url.contains(&quot;图&quot;)) IMAGE else VIDEO

    override fun toString(): String {
        return &quot;ShareData(urls=$urls, isFromSDK=$isFromSDK)&quot;
    }
}

interface ShareHandler {
    fun validate(shareData: ShareData): Boolean
    fun requestPermission(): Boolean
    fun doShare(shareData: ShareData)
}

class ShareHandlerImpl : ShareHandler {
    override fun validate(shareData: ShareData): Boolean {
        return shareData.urls.isNotEmpty()
    }

    override fun requestPermission() = throw NotImplementedError(&quot;未实现&quot;)
    override fun doShare(shareData: ShareData) = throw NotImplementedError(&quot;未实现&quot;)
}

class ShareFromSdkHandler(shareHandler: ShareHandler) : ShareHandler by shareHandler {
    override fun requestPermission(): Boolean {
        println(&quot;申请SDK分享权限&quot;)
        return true
    }
}

class ShareFromSystemHandler(shareHandler: ShareHandler) : ShareHandler by shareHandler {
    override fun requestPermission(): Boolean {
        println(&quot;申请系统分享权限&quot;)
        return true
    }
}

class ShareImageHandler(shareHandler: ShareHandler) : ShareHandler by shareHandler {
    override fun doShare(shareData: ShareData) {
        println(&quot;分享图片内容$shareData&quot;)
    }
}

class ShareVideoHandler(shareHandler: ShareHandler) : ShareHandler by shareHandler {
    override fun doShare(shareData: ShareData) {
        println(&quot;分享视频${shareData}&quot;)
    }
}

class ShareMixHandler(shareHandler: ShareHandler) : ShareHandler by shareHandler {
    override fun doShare(shareData: ShareData) {
        println(&quot;分享混合内容$shareData&quot;)
    }
}
</code></pre>
<p>还用上了位运算和Kotlin的<a href="https://www.kotlincn.net/docs/reference/delegation.html">类委托</a>，太卷了。</p>
<p>尝试画一下类图，这都是啥跟啥？</p>
<p><img src="https://i.loli.net/2021/07/19/aApWiNvOlfmdZTt.png" alt="ShareHandler.svg.png.lin.png" /></p>
<p>我对照着菜鸟教程确认了半天，确定这确实是个装饰模式。插入两个省略掉的抽象类就清楚很多了。</p>
<p><img src="https://i.loli.net/2021/07/19/yiSRrDhZx4AT9GI.png" alt="装饰模式.svg.png.lin.png" /></p>
<p>怎么说呢，代码简洁实现优雅，我要学习的还有很多！</p>
</div>
            </div>
    
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>