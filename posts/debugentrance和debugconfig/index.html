<!DOCTYPE html>
<html><head>
<title>DebugEntrance和DebugConfig</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="工欲善其事，必先利其器。毕设是一个相对复杂的项目了，我觉得要想顺利完成肯定是需要一些手段帮助我调试的。于是这里我准备了debug页面，主要功能就两个：提供某个功能的入口以及存储配置（最好能直接在手机上修改）">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="DebugEntrance和DebugConfig" />
<meta property="og:description" content="工欲善其事，必先利其器。毕设是一个相对复杂的项目了，我觉得要想顺利完成肯定是需要一些手段帮助我调试的。于是这里我准备了debug页面，主要功能就两个：提供某个功能的入口以及存储配置（最好能直接在手机上修改）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ntutn.top/posts/debugentrance%E5%92%8Cdebugconfig/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-22T03:11:37+08:00" />
<meta property="article:modified_time" content="2021-02-22T03:11:37+08:00" /><meta property="og:site_name" content="归零幻想" />














  




<link rel="icon" href="//images.ntutn.top/favicon.ico">



      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<link rel="stylesheet" href="/scss/journal.min.c5d92f380bf10f6849c7ac487c7df2b22c081e0851e5339224f1ae29210b20d2.css" integrity="sha256-xdkvOAvxD2hJx6xIfH3ysiwIHghR5TOSJPGuKSELINI=" media="screen">



<link rel="stylesheet" href="/scss/dark-mode.min.9f8d8c2df9285089d141edd4a50cb7506c7948e6ab79a29968dced1bd0ab7d22.css" integrity="sha256-n42MLfkoUInRQe3UpQy3UGx5SOareaKZaNztG9CrfSI=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



<script defer
	src='https://static.cloudflareinsights.com/beacon.min.js'
	data-cf-beacon='{"token": 5a03d307f5214109a1e7c8b2cf306a3d'>
</script>


















<style>
    pre code {
        color: black;
        -comment: "感谢评论区 https://github.com/lx200916 指出博客代码块深色模式问题";
    }
</style>
<script src="https://unpkg.com/zoomtastic@2.2.1"></script>
<script src="https://unpkg.com/kotlin-playground@1" data-selector="code.language-kotlin"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(event) { 
        document.querySelectorAll("div.post-body-wrapper img").forEach(function(element){
            element.setAttribute("zoomtastic", true)
            element.style.maxWidth="60%"
        })
		
		Zoomtastic.mount({
			size: '95%',
			easing: 'ease',
			duration: 300,
			background: 'rgba(0, 0, 0, 0.9)',
			filter: 'drop-shadow(0 2px 16px rgba(0, 0, 0, 0.3))',
			animation: 'slide' 
		});
		
		Zoomtastic.listen('[zoomtastic]', 'src');
    });

	
	var _hmt = _hmt || [];
	(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?298c58938f9266e6098936c4f71a9a83";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
	})();

</script>

</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://ntutn.top/">
    
        <div class="nav-title">
            归零幻想
        </div>
        
        <div class="nav-subtitle">
            零点还不算熬夜
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/zwiki">
                WIKI
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/project">
                项目
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                归档
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	CC BY-SA 4.0
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#debugentrance" onclick="onNavClick(`#debugentrance-nav`)" id="debugentrance-nav">
									DebugEntrance
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#debugconfig" onclick="onNavClick(`#debugconfig-nav`)" id="debugconfig-nav">
									DebugConfig
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8" onclick="onNavClick(`#使用-nav`)" id="使用-nav">
									使用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b1%9e%e6%80%a7%e5%a7%94%e6%89%98%e6%b3%9b%e5%9e%8b%e5%ae%9e%e5%8c%96" onclick="onNavClick(`#属性委托泛型实化-nav`)" id="属性委托泛型实化-nav">
									属性委托、泛型实化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%85%8d%e7%bd%ae%e7%9a%84%e5%ad%98%e5%8f%96" onclick="onNavClick(`#配置的存取-nav`)" id="配置的存取-nav">
									配置的存取
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b3%a8%e8%a7%a3%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#注解定义-nav`)" id="注解定义-nav">
									注解定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b3%a8%e8%a7%a3%e7%9a%84%e7%bc%96%e8%af%91%e6%9c%9f%e5%a4%84%e7%90%86" onclick="onNavClick(`#注解的编译期处理-nav`)" id="注解的编译期处理-nav">
									注解的编译期处理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%97%a5%e5%bf%97%e8%be%93%e5%87%ba" onclick="onNavClick(`#日志输出-nav`)" id="日志输出-nav">
									日志输出
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%a1%e6%81%af%e6%94%b6%e9%9b%86" onclick="onNavClick(`#信息收集-nav`)" id="信息收集-nav">
									信息收集
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kotlin%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" onclick="onNavClick(`#kotlin代码生成-nav`)" id="kotlin代码生成-nav">
									Kotlin代码生成
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" onclick="onNavClick(`#初始化-nav`)" id="初始化-nav">
									初始化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%ae%a1%e7%90%86%e9%9d%a2%e6%9d%bf" onclick="onNavClick(`#管理面板-nav`)" id="管理面板-nav">
									管理面板
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/zwiki">
                    WIKI
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/project">
                    项目
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    归档
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#debugentrance" onclick="onNavClick(`#debugentrance-nav`)" id="debugentrance-nav">
									DebugEntrance
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#debugconfig" onclick="onNavClick(`#debugconfig-nav`)" id="debugconfig-nav">
									DebugConfig
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8" onclick="onNavClick(`#使用-nav`)" id="使用-nav">
									使用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b1%9e%e6%80%a7%e5%a7%94%e6%89%98%e6%b3%9b%e5%9e%8b%e5%ae%9e%e5%8c%96" onclick="onNavClick(`#属性委托泛型实化-nav`)" id="属性委托泛型实化-nav">
									属性委托、泛型实化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%85%8d%e7%bd%ae%e7%9a%84%e5%ad%98%e5%8f%96" onclick="onNavClick(`#配置的存取-nav`)" id="配置的存取-nav">
									配置的存取
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b3%a8%e8%a7%a3%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#注解定义-nav`)" id="注解定义-nav">
									注解定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b3%a8%e8%a7%a3%e7%9a%84%e7%bc%96%e8%af%91%e6%9c%9f%e5%a4%84%e7%90%86" onclick="onNavClick(`#注解的编译期处理-nav`)" id="注解的编译期处理-nav">
									注解的编译期处理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%97%a5%e5%bf%97%e8%be%93%e5%87%ba" onclick="onNavClick(`#日志输出-nav`)" id="日志输出-nav">
									日志输出
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%a1%e6%81%af%e6%94%b6%e9%9b%86" onclick="onNavClick(`#信息收集-nav`)" id="信息收集-nav">
									信息收集
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kotlin%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" onclick="onNavClick(`#kotlin代码生成-nav`)" id="kotlin代码生成-nav">
									Kotlin代码生成
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" onclick="onNavClick(`#初始化-nav`)" id="初始化-nav">
									初始化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%ae%a1%e7%90%86%e9%9d%a2%e6%9d%bf" onclick="onNavClick(`#管理面板-nav`)" id="管理面板-nav">
									管理面板
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://ntutn.top/">
            归零幻想
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://ntutn.top/">
        <div class="single-column-header-title">归零幻想</div>
        
        <div class="single-column-header-subtitle">零点还不算熬夜</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://i.loli.net/2021/02/22/gOV6niTxoBfXbWv.jpg')"
                    
                
            >
                <div class="post-title">
                    DebugEntrance和DebugConfig
                    
                    <div class="post-subtitle">
                        工欲善其事，必先利其器。毕设是一个相对复杂的项目了，我觉得要想顺利完成肯定是需要一些手段帮助我调试的。于是这里我准备了debug页面，主要功能就两个：提供某个功能的入口以及存储配置（最好能直接在手机上修改）
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2021-02-22 03:11
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/%E5%AE%89%E5%8D%93">安卓</a>
                                &nbsp;
                            
                                <a href="/tags/%E6%AF%95%E8%AE%BE">毕设</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            14 min
                            
                            24 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <!-- raw HTML omitted -->
<p>工欲善其事，必先利其器。毕设是一个相对复杂的项目了，我觉得要想顺利完成肯定是需要一些手段帮助我调试的。于是这里我准备了debug页面，主要功能就两个：提供某个功能的入口以及存储配置（最好能直接在手机上修改）</p>
<h2 id="debugentrance">DebugEntrance</h2>
<p>就是一个各种测试功能的入口。</p>
<p><img src="https://i.loli.net/2021/02/22/gOV6niTxoBfXbWv.jpg" alt="1.jpg"></p>
<p>这个一看实现就很简单，不细说了。</p>
<h2 id="debugconfig">DebugConfig</h2>
<p>因为字节自己的ABManager用着挺顺手，感觉自己项目调试时有类似这么个东西会比较舒服，于是搞了这么个东西。</p>
<p><img src="https://i.loli.net/2021/02/22/Mi8lCJdZBcjnYmO.jpg" alt="2.jpg"> <img src="https://i.loli.net/2021/02/22/cEAfgMVPzrSXmuY.jpg" alt="3.jpg"></p>
<h3 id="使用">使用</h3>
<p>先看使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#707a7c">@ZeroConfig</span>(key = <span style="color:#cd5555">&#34;retrofit_config&#34;</span>, title = <span style="color:#cd5555">&#34;Retrofit配置&#34;</span>, owner = <span style="color:#cd5555">&#34;liuhaixin.zero&#34;</span>)
<span style="color:#8b008b;font-weight:bold">data</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">RetrofitConfig</span>(<span style="color:#8b008b;font-weight:bold">val</span> baseUrl: String = RetrofitUtil.BASE_URL)
<span style="color:#8b008b;font-weight:bold">private</span> <span style="color:#8b008b;font-weight:bold">val</span> retrofitConfig <span style="color:#8b008b;font-weight:bold">by</span> zeroConfig&lt;RetrofitConfig&gt;()
<span style="color:#8b008b;font-weight:bold">private</span> <span style="color:#8b008b;font-weight:bold">val</span> retrofit <span style="color:#8b008b;font-weight:bold">by</span> lazy {
    Retrofit.Builder()
        .baseUrl(retrofitConfig?.baseUrl ?: BASE_URL)
        .addConverterFactory(GsonConverterFactory.create())
        .client(okHttpClient)
        .build()
}
</code></pre></div><p>看上去还是有点让人心动的吧。</p>
<!-- raw HTML omitted -->
<h3 id="属性委托泛型实化">属性委托、泛型实化</h3>
<p>首先是一段来自<a href="https://www.runoob.com/kotlin/kotlin-delegated.html">菜鸟教程</a>的描述：</p>
<hr>
<p>属性委托指的是一个类的某个属性值不是在类中直接进行定义，而是将其托付给一个代理类，从而实现对该类属性的统一管理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">val</span>/<span style="color:#8b008b;font-weight:bold">var</span> <span style="color:#a61717;background-color:#e3d2d2">&lt;</span>属性名&gt;: &lt;类型&gt; <span style="color:#8b008b;font-weight:bold">by</span> &lt;表达式&gt;
</code></pre></div><p>by 关键字之后的表达式就是委托, 属性的 get() 方法(以及set() 方法)将被委托给这个对象的 getValue() 和 setValue() 方法。属性委托不必实现任何接口, 但必须提供 getValue() 函数(对于 var属性,还需要 setValue() 函数)。</p>
<hr>
<p>借助这个特征，我们可以定义这样一个委托类：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">ZeroConfigDelegate</span>&lt;T&gt;(<span style="color:#8b008b;font-weight:bold">private</span> <span style="color:#8b008b;font-weight:bold">val</span> clazz: Class&lt;T&gt;) {
    <span style="color:#8b008b;font-weight:bold">operator</span> <span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">getValue</span>(thisRef: Any?, <span style="color:#8b008b;font-weight:bold">property</span>: KProperty&lt;*&gt;): T? =
        ZeroConfigHelper.readConfig(clazz)
    <span style="color:#8b008b;font-weight:bold">operator</span> <span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">setValue</span>(thisRef: Any?, <span style="color:#8b008b;font-weight:bold">property</span>: KProperty&lt;*&gt;, value: T?) =
        ZeroConfigHelper.saveConfig(clazz, value)
}
</code></pre></div><p>这样我们需要存取配置的时候只要</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">var</span> config <span style="color:#8b008b;font-weight:bold">by</span> ZeroConfigDelegate(ConfigClass::<span style="color:#8b008b;font-weight:bold">class</span>.java)
<span style="color:#228b22">// 存
</span><span style="color:#228b22"></span>config = ConfigClass(arg)
<span style="color:#228b22">// 取
</span><span style="color:#228b22"></span>println(config.key1)
</code></pre></div><p>接下来定义一个顶级函数（<em>我也不知道这样有啥好处，但看Kotlin库lazy函数就是这样实现的</em>）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#228b22">/**
</span><span style="color:#228b22"> * 委托获取配置值
</span><span style="color:#228b22"> * @param clazz 配置类型
</span><span style="color:#228b22"> */</span>
<span style="color:#8b008b;font-weight:bold">fun</span> &lt;<span style="color:#008b45;font-weight:bold">T</span>&gt; <span style="color:#008b45">zeroConfig</span>(clazz: Class&lt;T&gt;): ZeroConfigDelegate&lt;T&gt; = ZeroConfigDelegate(clazz)
</code></pre></div><p>相对java的泛型，Kotlin还提供了一个叫做“泛型实化”的东西，可以进一步让我们上面写法更优雅：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#228b22">/**
</span><span style="color:#228b22"> * 委托获取配置值
</span><span style="color:#228b22"> * 泛型实化，调用更方便
</span><span style="color:#228b22"> */</span>
<span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#8b008b;font-weight:bold">fun</span> &lt;<span style="color:#8b008b;font-weight:bold">reified</span> <span style="color:#008b45;font-weight:bold">T</span>&gt; <span style="color:#008b45">zeroConfig</span>(): ZeroConfigDelegate&lt;T&gt; =
    zeroConfig(T::<span style="color:#8b008b;font-weight:bold">class</span>.java)
</code></pre></div><p>现在调用时就是开始的那个例子那样了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">var</span> config <span style="color:#8b008b;font-weight:bold">by</span> zeroConfig&lt;ConfigClass&gt;()
<span style="color:#228b22">// 存
</span><span style="color:#228b22"></span>config = ConfigClass(arg)
<span style="color:#228b22">// 取
</span><span style="color:#228b22"></span>println(config.key1)
</code></pre></div><h3 id="配置的存取">配置的存取</h3>
<p>这里代码目前实现很简单，就是直接转换成json然后存到sp里。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">fun</span> &lt;<span style="color:#008b45;font-weight:bold">T</span>&gt; <span style="color:#008b45">saveConfig</span>(clazz: Class&lt;*&gt;, value: T) {
    bufferMap[clazz] = value
    sp.edit {
        putString(getKeyOfClass(clazz), gson.toJson(value))
    }
}
<span style="color:#8b008b;font-weight:bold">fun</span> &lt;<span style="color:#008b45;font-weight:bold">T</span>&gt; <span style="color:#008b45">readConfig</span>(clazz: Class&lt;*&gt;): T {
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">if</span> (bufferMap.containsKey(clazz)) {
        bufferMap[clazz]
    } <span style="color:#8b008b;font-weight:bold">else</span> {
        <span style="color:#8b008b;font-weight:bold">val</span> jsonString = sp.getString(getKeyOfClass(clazz), <span style="color:#cd5555">&#34;{}&#34;</span>)
        gson.fromJson(jsonString, clazz)
    } <span style="color:#8b008b;font-weight:bold">as</span> T
}
</code></pre></div><h3 id="注解定义">注解定义</h3>
<p>注意上面有一个<code>getKeyOfClass(clazz)</code>，这个方法是怎么实现的？</p>
<p>其实如果照目前为止，只要保证定义的配置字段key互不相同就行了，那么可以直接用<code>clazz.canonicalName</code>。不过我们这里的需求还希望实现一个能直接在手机操作的管理界面，所以用注解去定义下配置字段相关的信息会比较好。</p>
<p>首先新建一个kotlin模块（注意不是安卓模块），叫做libzeroconfig，用来放我们的注解，这样后面用到的地方直接导入这个模块就行了。</p>
<p>参考字节的ABManager，我这样定义我的注解</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">package</span> <span style="color:#008b45;text-decoration:underline">top.ntutn.libzeroconfig</span>
<span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">kotlin.reflect.KClass</span>
<span style="color:#228b22">/**
</span><span style="color:#228b22"> * 标注于配置实体类之上，指定配置字段名
</span><span style="color:#228b22"> * @param key 配置字段
</span><span style="color:#228b22"> * @param title 配置项名（给人看的）
</span><span style="color:#228b22"> * @param owner 负责人
</span><span style="color:#228b22"> * @param scope 所属的业务线
</span><span style="color:#228b22"> */</span>
<span style="color:#707a7c">@Target</span>(AnnotationTarget.CLASS)
<span style="color:#707a7c">@Retention</span>(AnnotationRetention.SOURCE)
<span style="color:#8b008b;font-weight:bold">annotation</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">ZeroConfig</span>(
    <span style="color:#8b008b;font-weight:bold">val</span> key: String,
    <span style="color:#8b008b;font-weight:bold">val</span> title: String = <span style="color:#cd5555">&#34;&#34;</span>,
    <span style="color:#8b008b;font-weight:bold">val</span> owner: String,
    <span style="color:#8b008b;font-weight:bold">val</span> scope: KClass&lt;<span style="color:#8b008b;font-weight:bold">out</span> ZeroScope&gt; = DefaultScope::<span style="color:#8b008b;font-weight:bold">class</span>
<span style="color:#a61717;background-color:#e3d2d2">)</span>
</code></pre></div><p>要求key和owner必须填写，title是这个配置在本地管理面板中显示的名字。一目了然。</p>
<p>这个注解要标在定义的配置实体类上，注意如果是data class要求所有字段都提供默认值，因为否则的话gson反射创建对象的时候会因为data class没有默认构造函数遇到问题。虽然这个问题可以通过应用kotlin-noarg插件解决，但我觉得强制要求所有配置类都提供所有字段的默认值也不错。</p>
<h3 id="注解的编译期处理">注解的编译期处理</h3>
<p>Retention指定的合适，注解是可以被带到运行期间的。看springboot的一大票注解，上面指定的都是<code>@Retention(RetentionPolicy.RUNTIME)</code>。</p>
<p>但你可以注意到我上面注解定义的代码并没有这么做，安卓上大家基本都尽量不这么做。springboot可以在运行时递归扫描注解，但我们安卓手机上来说这个开销就太大了。</p>
<p>所以要在编译期间把这个事情（扫描注解信息）办妥，所以就要用到<code>kapt</code>了（安卓上此前这个事情是用<code>annotationProcessor</code>处理）</p>
<blockquote>
<p>kapt 即 Kotlin annotation processing tool（Kotlin 注解处理工具）缩写。通过定义注解处理器可以在编译时对源代码进行检测生成额外的源文件和其他文件，之后编译生成的源文件和原来的源文件一起生成class文件。
听上去很cool的操作，使人不由自主联想到如果生成的源文件还有这个注解咋办……答案是kapt会执行多次，直到没有新的注解发现为止。虽然这对我们这个需求没啥用处。</p>
</blockquote>
<p>仍然是定义一个kotlin模块，这次叫<code>libzeroconfigcompiler</code>吧。在这里我们定义我们的注解处理器。</p>
<p>其实要做的事情就两件：</p>
<ol>
<li>定义一个类继承自AbstractProcessor</li>
<li>把你的类名（带包名）写到META-INF/service/javax.annotation.processing.Processor中</li>
</ol>
<p>对于第二步，Google提供了一个叫<code>auto service</code>的东西可以帮我们生成这个文件，只要引入后在你的Annotation Processor类上加上<code>@AutoService(Processor.class)</code>就可以了。</p>
<p>至于这个注解处理类的实现，建议还是别看我代码了，有两个我认为很值得参考的项目：一个是前面提到的<a href="https://github.com/google/auto/tree/master/service">Auto Service</a>，另一个是<a href="https://github.com/greenrobot/EventBus/tree/master/EventBusAnnotationProcessor">EventBus的注解处理器</a>。</p>
<h4 id="日志输出">日志输出</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">note</span>(message: String) {
    processingEnv.messager.printMessage(Diagnostic.Kind.NOTE, <span style="color:#cd5555">&#34;</span><span style="color:#cd5555">$message</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>)
}
<span style="color:#228b22">// \r\n换行 https://medium.com/@cafonsomota/annotation-processor-printing-a-message-and-doing-it-in-a-new-line-1b6609e86e5c
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">warning</span>(message: String) {
    processingEnv.messager.printMessage(Diagnostic.Kind.WARNING, <span style="color:#cd5555">&#34;</span><span style="color:#cd5555">$message</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>)
}
<span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">error</span>(message: String) {
    processingEnv.messager.printMessage(Diagnostic.Kind.ERROR, <span style="color:#cd5555">&#34;</span><span style="color:#cd5555">$message</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>)
}
</code></pre></div><p>注意：<strong>换行要用\r\n，另外error会让编译终止</strong></p>
<h4 id="信息收集">信息收集</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">override</span> <span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">process</span>(
    annotations: MutableSet&lt;<span style="color:#8b008b;font-weight:bold">out</span> TypeElement&gt;,
    roundEnvironment: RoundEnvironment
): Boolean {
    counter++
    note(<span style="color:#cd5555">&#34;Processing round </span><span style="color:#cd5555">$counter</span><span style="color:#cd5555">, new annotations: </span><span style="color:#cd5555">${annotations.isNotEmpty()}</span><span style="color:#cd5555">, processingOver: </span><span style="color:#cd5555">${roundEnvironment.processingOver()}</span><span style="color:#cd5555">&#34;</span>)
    <span style="color:#8b008b;font-weight:bold">if</span> (roundEnvironment.processingOver() &amp;&amp; annotations.isNotEmpty()) {
        error(<span style="color:#cd5555">&#34;Unexpected processing state: annotations still available after processing over&#34;</span>)
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">false</span>
    }
    <span style="color:#8b008b;font-weight:bold">if</span> (annotations.isEmpty()) {
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">false</span>
    }
    <span style="color:#8b008b;font-weight:bold">if</span> (wasWrittenToFile) {
        error(<span style="color:#cd5555">&#34;Unexpected processing state: annotations still available after writing.&#34;</span>)
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">false</span>
    }
    <span style="color:#228b22">// 收集数据
</span><span style="color:#228b22"></span>    roundEnvironment.getElementsAnnotatedWith(ZeroConfig::<span style="color:#8b008b;font-weight:bold">class</span>.java).forEach { element -&gt;
        <span style="color:#228b22">//使用了注解的某个类
</span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (element !is TypeElement) {
            error(<span style="color:#cd5555">&#34;注解只能标记在实体类上：</span><span style="color:#cd5555">$element</span><span style="color:#cd5555">&#34;</span>)
            <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">false</span>
        }
        <span style="color:#8b008b;font-weight:bold">val</span> annotation = element.getAnnotation(ZeroConfig::<span style="color:#8b008b;font-weight:bold">class</span>.java)
        <span style="color:#8b008b;font-weight:bold">if</span> (!checkAnnotationValid(<span style="color:#8b008b;font-weight:bold">annotation</span>)) <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">false</span>
        classInfoMap[<span style="color:#8b008b;font-weight:bold">annotation</span>.key] = ZeroConfigInformation(
            key = <span style="color:#8b008b;font-weight:bold">annotation</span>.key,
            clazz = element.qualifiedName.toString(),
            title = <span style="color:#8b008b;font-weight:bold">annotation</span>.title,
            scope = getClassFromAnnotation { <span style="color:#8b008b;font-weight:bold">annotation</span>.scope.qualifiedName!! },
            owner = <span style="color:#8b008b;font-weight:bold">annotation</span>.owner
        )
    }
    generateCode()
    wasWrittenToFile = <span style="color:#8b008b;font-weight:bold">true</span>
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">true</span>
}
</code></pre></div><p>要注意的其实也就是annotationProcessor会多次执行，做好处理。</p>
<blockquote>
<p>通过filer写文件是不允许覆盖的，在此前我尝试用了某个有点dirty的方法绕过了这个限制，但后来看了EventBus的实现后改为了现在这个样子。
注意上面有一个<code>scope = getClassFromAnnotation { annotation.scope.qualifiedName!! }</code>，怎么说呢，又是一个有点dirty的实现：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#228b22">/**
</span><span style="color:#228b22"> * 获取annotation中的Class
</span><span style="color:#228b22"> * https://www.jianshu.com/p/6822278f4771
</span><span style="color:#228b22"> */</span>
<span style="color:#8b008b;font-weight:bold">private</span> <span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">getClassFromAnnotation</span>(block: () -&gt; String): String {
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">try</span> {
        block()
    } <span style="color:#8b008b;font-weight:bold">catch</span> (e: MirroredTypeException) {
        e.typeMirror.toString()
    }
}
</code></pre></div><p>因为定义的类还没编译，所以会抛出异常，然后在异常中拿到了这个类名……想到这个方法的人真是鬼才。</p>
<h4 id="kotlin代码生成">Kotlin代码生成</h4>
<p>KotlinPoet，使用方法和javapoet类似。它原来有个slogan挺吸引我的，大意是用最美的Kotlin代码生成最美的Kotlin代码。</p>
<p><a href="https://square.github.io/kotlinpoet/">KotlinPoet - KotlinPoet (square.github.io)</a></p>
<p>其实我们要生成的类很简单，只拼接字符串就能完成，<em>但用KotlinPoet显然逼格高不少。</em></p>
<h3 id="初始化">初始化</h3>
<p>前面步骤之后就已经生成了多个类文件了，他们形如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">ZeroConfigHolder</span> : IZeroConfigHolder {
  <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">override</span> <span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">getValue</span>(): Map&lt;String, ZeroConfigInformation&gt; = mapOf(<span style="color:#cd5555">&#34;metrics_config&#34;</span> to
      top.ntutn.libzeroconfig.ZeroConfigInformation(key=<span style="color:#cd5555">&#34;metrics_config&#34;</span>,title=<span style="color:#cd5555">&#34;埋点配置&#34;</span>,clazz=<span style="color:#cd5555">&#34;top.ntutn.commonutil.MetricsConfig&#34;</span>,scope=<span style="color:#cd5555">&#34;top.ntutn.libzeroconfig.DefaultScope&#34;</span>,owner=<span style="color:#cd5555">&#34;liuhaixin.zero&#34;</span>))
}
</code></pre></div><p>但我们还是要在启动时注册一下，这样就可以在管理面板枚举出所有配置项了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">ZeroConfigHelper.<span style="color:#8b008b;font-weight:bold">init</span>(applicationContext)
    .addConfigHolder(top.ntutn.zeroconfigutil.ZeroConfigHolder())
    .addConfigHolder(ZeroConfigHolder())
    .addConfigHolder(top.ntutn.commonutil.ZeroConfigHolder())
</code></pre></div><h3 id="管理面板">管理面板</h3>
<p>为了提供一个通用的配置编辑界面，还是准备个json的存取方式比较合理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">readRawConfig</span>(key: String): String? {
    <span style="color:#8b008b;font-weight:bold">val</span> clazz = getClassByKey(key) ?: <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">null</span>
    <span style="color:#8b008b;font-weight:bold">var</span> rawString = sp.getString(getKeyOfClass(clazz), <span style="color:#8b008b;font-weight:bold">null</span>)
    <span style="color:#228b22">// 正确显示配置的默认值
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (rawString == <span style="color:#8b008b;font-weight:bold">null</span>) {
        rawString = gson.toJson(clazz.newInstance())
    }
    <span style="color:#8b008b;font-weight:bold">return</span> rawString
}
<span style="color:#707a7c">@Throws</span>(ClassNotFoundException::<span style="color:#8b008b;font-weight:bold">class</span>)
<span style="color:#8b008b;font-weight:bold">fun</span> <span style="color:#008b45">saveRawConfig</span>(key: String, value: String) {
    <span style="color:#8b008b;font-weight:bold">val</span> clazz = getClassByKey(key) ?: <span style="color:#8b008b;font-weight:bold">throw</span> ClassNotFoundException(<span style="color:#cd5555">&#34;未找到配置项：</span><span style="color:#cd5555">$key</span><span style="color:#cd5555">&#34;</span>)
    bufferMap.remove(clazz)
    sp.edit {
        putString(getKeyOfClass(clazz), value)
    }
}
</code></pre></div><p>剩下的就是准备一个配置列表和编辑界面，也没什么值得说的了。</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">最后修改于 2021-02-22</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/classloader%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%89%98%E6%9C%BA%E5%88%B6%E6%8E%A2%E7%A9%B6/">
			下回<br>ClassLoader双亲委托机制探究
                </a>
                
                
                
                <a class="older-posts" href="/posts/viewbindingviewmodel%E5%92%8Clivedata/">
			上回<br>ViewBinding、ViewModel和LiveData
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                










<script src="https://utteranc.es/client.js"
        repo="zerofancy/zerofancy.github.io"
        issue-term="title"
        label=""
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	CC BY-SA 4.0
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
